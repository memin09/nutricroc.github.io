<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Nutricroc</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500&family=Great+Vibes&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* RESET Y ESTILOS BASE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ESTILOS PARA SCROLLBARS */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #295732;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #1e3d24;
    }

    /* Para Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: #295732 #f1f1f1;
    }

    body {
      font-family: 'Playfair Display', serif;
      background: #F5F5DC;
      color: #333;
      overflow-x: hidden;
    }

    /* PANTALLA DE TRANSICIÓN */
    .transition-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .transition-screen.active {
      display: flex;
      opacity: 1;
    }

    .transition-image {
      width: 250px;
      height: 250px;
      object-fit: contain;
      margin-bottom: 20px;
    }

    /* NOTIFICACIONES */
    .notification {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%) translateY(-100%);
      background-color: #295732;
      color: white;
      padding: 15px 30px;
      text-align: center;
      z-index: 2000;
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 0 0 10px 10px;
      max-width: 400px;
      width: 90%;
    }

    .notification.show {
      transform: translateX(-50%) translateY(0);
    }

    .notification-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .payment-error-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background-color: #dc3545;
      color: white;
      padding: 20px 30px;
      text-align: center;
      z-index: 4000;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transition: transform 0.3s ease, opacity 0.3s ease;
      opacity: 0;
      max-width: 500px;
      width: 90%;
      font-family: 'Playfair Display', serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .payment-error-notification.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .stock-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background-color: #dc3545;
      color: white;
      padding: 25px 40px;
      text-align: center;
      z-index: 3000;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transition: transform 0.3s ease, opacity 0.3s ease;
      opacity: 0;
      max-width: 500px;
      width: 90%;
      font-family: 'Playfair Display', serif;
    }

    .stock-notification.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    /* PANTALLA COMPLETA DE CHECKOUT */
    .checkout-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 3000;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .checkout-fullscreen.active {
      display: flex;
    }

    .checkout-full-header {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px 40px;
      border-bottom: 1px solid #eee;
      background: white;
      z-index: 10;
      position: relative;
    }

    .checkout-full-title {
      font-family: 'Playfair Display', serif;
      font-size: 30px;
      color: #295732;
      margin: 0;
    }

    /* Se eliminó el botón de cerrar */
    .close-checkout-full {
      display: none;
    }

    .checkout-full-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* PANEL IZQUIERDO: RESUMEN DE COMPRA */
    .checkout-left-panel {
      flex: 1;
      background:  white;
      padding: 30px;
      overflow: hidden;
      border-right: 1px solid #eee;
      display: flex;
      flex-direction: column;
    }
    
    .checkout-summary-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 5;
      padding-bottom: 15px;
    }

    .checkout-summary-fixed {
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .checkout-summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #295732;
      margin-bottom: 15px;
    }

    .checkout-summary-count {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .checkout-products-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
      margin: 20px 0;
    }
    
    /* Scroll personalizado para lista de productos */
    .checkout-products-list::-webkit-scrollbar {
      width: 4px;
    }
    
    .checkout-products-list::-webkit-scrollbar-thumb {
      background: #295732;
    }
    
    .checkout-summary-footer {
      position: sticky;
      bottom: 0;
      background: white;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }

    .checkout-product-item {
      display: flex;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e5e5;
    }

    .checkout-product-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      margin-right: 15px;
    }

    .checkout-product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .checkout-product-details {
      flex: 1;
    }

    .checkout-product-name {
      font-size: 16px;
      font-weight: 600;
    }

    .checkout-product-quantity {
      font-size: 14px;
      color: #777;
    }

    .checkout-product-price {
      font-weight: bold;
      margin-top: 5px;
    }

    .checkout-summary-total {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .summary-total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .summary-total-label {
      color: #666;
    }

    .summary-total-value {
      font-weight: 500;
      color: #1e3d24;
    }

    .summary-grand-total {
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }

    /* PANEL DERECHO: PASOS DEL CHECKOUT */
    .checkout-right-panel {
      flex: 1.5;
      padding: 30px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    /* Scroll personalizado para panel derecho */
    .checkout-right-panel::-webkit-scrollbar {
      width: 4px;
    }
    
    .checkout-right-panel::-webkit-scrollbar-thumb {
      background: #295732;
    }

    /* BARRA DE PROGRESO */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 30px auto 40px;
      position: relative;
      max-width: 600px;
      width: 100%;
    }

    .progress-bar::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 10%;
      right: 10%;
      height: 3px;
      background: #eee;
      z-index: 1;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      flex: 1;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: white;
      border: 2px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #999;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .progress-step.active .step-circle {
      background: #295732;
      border-color: #295732;
      color: white;
    }

    .progress-step.completed .step-circle {
      background: #295732;
      border-color: #295732;
      color: white;
    }

    .step-label {
      font-size: 14px;
      color: #999;
      text-align: center;
    }

    .progress-step.active .step-label {
      color: #295732;
      font-weight: 500;
    }

    .progress-step.completed .step-label {
      color: #295732;
    }

    /* PASOS DEL CHECKOUT */
    .checkout-step {
      display: none;
      flex-direction: column;
      flex: 1;
    }

    .checkout-step.active {
      display: flex;
    }

    .step-title {
      font-size: 24px;
      color: #295732;
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Cormorant Garamond', serif;
      font-weight: 600;
    }

    .step-image-container {
      text-align: center;
      margin-bottom: 30px;
    }

    .step-image {
      width: 250px;
      height: 180px;
      object-fit: contain;
      margin: 0 auto;
    }

    /* PASO 1: DATOS DE ENTREGA */
    .delivery-form {
      display: flex;
      flex-direction: column;
      gap: 25px;
      max-width: 500px;
      margin: 0 auto;
      padding: 0 20px 20px;
      width: 100%;
      box-sizing: border-box;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 16px;
      color: #555;
      font-weight: 500;
      margin-bottom: 5px;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      padding: 14px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Playfair Display', serif;
      outline: none;
      transition: border-color 0.3s ease;
      background-color: white;
      width: 100%;
      box-sizing: border-box;
    }

    /* Cambiar color del texto de selects a negro */
    .form-group select option {
      color: #000 !important;
      background-color: white;
    }

    .form-group select {
      color: #000 !important;
      background-color: white;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      border-color: #295732;
      box-shadow: 0 0 0 2px rgba(41, 87, 50, 0.2);
    }

    .form-group select:disabled {
      background-color: #f5f5f5;
      cursor: not-allowed;
      color: #666 !important;
    }

    /* Personalización de selects para móviles */
    @media (max-width: 768px) {
      .form-group select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 16px;
        padding-right: 45px;
        color: #000 !important;
      }
      
      .form-group select:disabled {
        background-color: #f5f5f5;
        opacity: 0.7;
        color: #666 !important;
      }
    }

    /* PASO 2: MÉTODO DE PAGO */
    .payment-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 30px 0;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      padding: 0 20px;
      width: 100%;
      box-sizing: border-box;
    }

    .payment-option {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 18px 20px;
      border: 2px solid #eee;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      background-color: white;
    }

    .payment-option:hover {
      border-color: #295732;
    }

    .payment-option.selected {
      border-color: #295732;
      background-color: rgba(41, 87, 50, 0.1);
    }

    .payment-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #295732;
    }

    .payment-label {
      font-size: 18px;
      font-weight: 500;
      color: #333;
      flex: 1;
    }

    .payment-radio {
      display: flex;
      align-items: center;
    }

    .payment-radio input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin: 0;
    }

    .card-fields {
      display: none;
      flex-direction: column;
      gap: 20px;
      margin-top: 30px;
      padding: 25px;
      background-color: #f9f9f9;
      border-radius: 12px;
      animation: fadeIn 0.3s ease;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      width: 100%;
      box-sizing: border-box;
    }

    .card-fields.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .expiry-cvv-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    /* PASO 3: CONFIRMACIÓN */
    .confirmation-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 30px;
      text-align: center;
      flex: 1;
    }

    .confetti-success {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #295732;
      opacity: 0.8;
      border-radius: 2px;
      animation: fall linear forwards;
    }

    .confetti:nth-child(2n) {
      background-color: #1e3d24;
    }

    .confetti:nth-child(3n) {
      background-color: #704214;
    }

    .confetti:nth-child(4n) {
      background-color: #76DCD8;
    }

    @keyframes fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      70% {
        opacity: 0.8;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    .confirmation-image-large {
      width: 300px;
      height: 200px;
      object-fit: contain;
      margin-bottom: 15px;
    }

    .confirmation-title {
      font-family: 'Classy Marisa';
      font-size: 40px;
      color: #295732;
      margin-bottom: 25px;
    }

    .confirmation-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 25px;
      max-width: 500px;
      line-height: 1.6;
    }

    /* BOTONES DE NAVEGACIÓN */
    .checkout-navigation {
      display: flex;
      gap: 15px;
      margin-top: 40px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      width: 100%;
      box-sizing: border-box;
    }

    .nav-btn {
      flex: 1;
      background: #C9B656;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 30px;
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .nav-btn:hover {
      background: #C9B656;
      transform: translateY(-3px);
    }

    .nav-btn-secondary {
      background: #C9B656;
      color: white;
    }

    .nav-btn-secondary:hover {
      background: #C9B656;
    }

    .nav-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
      opacity: 0.6;
    }

    .nav-btn:disabled:hover {
      background-color: #cccccc;
      transform: none;
    }

    .reenviar-correo-btn {
      background: #C9B656;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 30px;
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
      min-width: 180px;
    }

    .reenviar-correo-btn:hover:not(:disabled) {
      background: #b5a44e;
      transform: translateY(-2px);
    }

    .reenviar-correo-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* SPINNER PARA CAMBIO DE PASO */
    .step-spinner {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .step-spinner.active {
      display: flex;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(41, 87, 50, 0.3);
      border-radius: 50%;
      border-top-color: #295732;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .step-spinner-text {
      font-size: 18px;
      color: #333;
      font-weight: 500;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* BOTÓN PARA ABRIR EL CHECKOUT (DEMO) - ELIMINADO */
    .demo-btn {
      display: none;
    }

    /* BOTÓN X PARA MÓVILES - OCULTADO */
    .mobile-close-btn {
      display: none !important;
    }

    /* RESPONSIVE */
    @media (min-width: 1025px) {
      /* Para PC se conserva todo como está */
      .checkout-full-content {
        flex-direction: row;
      }
      
      .checkout-left-panel {
        display: flex;
      }
      
      .checkout-right-panel {
        max-height: none;
      }
    }

    @media (max-width: 1024px) {
      .checkout-full-content {
        flex-direction: row;
      }
      
      .checkout-left-panel {
        border-right: none;
        max-height: none;
      }
      
      .checkout-right-panel {
        max-height: none;
      }
    }

    @media (max-width: 768px) {
      /* Ocultar resumen de compra en móviles */
      .checkout-left-panel {
        display: none !important;
      }
      
      /* Hacer que el panel derecho ocupe todo el espacio */
      .checkout-right-panel {
        flex: 1;
        width: 100%;
      }
      
      /* Ajustes para móviles */
      .checkout-full-header {
        padding: 15px 20px;
        position: relative;
      }
      
      .checkout-right-panel {
        padding: 20px 15px;
      }
      
      .progress-bar {
        padding: 0 10px;
        margin: 20px auto 30px;
      }
      
      .step-label {
        font-size: 12px;
      }
      
      .step-title {
        font-size: 22px;
        margin-bottom: 20px;
      }
      
      .checkout-navigation {
        flex-direction: column;
        gap: 10px;
        margin-top: 30px;
      }
      
      .step-image {
        width: 200px;
        height: 150px;
      }
      
      .confirmation-title {
        font-size: 32px;
      }
      
      .confirmation-message {
        font-size: 16px;
        padding: 0 10px;
      }
      
      /* Unificar diseño de formularios en móviles */
      .delivery-form,
      .payment-options,
      .card-fields {
        padding: 0 10px;
        gap: 20px;
      }
      
      .payment-option {
        padding: 15px;
      }
      
      .payment-label {
        font-size: 16px;
      }
      
      .card-fields {
        padding: 20px 15px;
        gap: 15px;
      }
      
      .expiry-cvv-container {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      /* Ajustar la imagen de confirmación */
      .confirmation-image-large {
        width: 250px;
        height: 180px;
      }
      
      /* Ajustar tamaño de texto en confirmación */
      .confirmation-content .checkout-summary-total {
        font-size: 14px;
        padding: 15px;
      }
      
      .summary-total-row {
        font-size: 14px;
      }
      
      .summary-grand-total {
        font-size: 16px;
      }
      
      /* Ajustar imagen de transición para móviles */
      .transition-image {
        width: 200px;
        height: 200px;
      }
      
      /* PREVENIR ZOOM AL HACER FOCUS EN CAMPOS DE ENTRADA EN MÓVILES */
      .form-group input,
      .form-group select,
      .form-group textarea,
      .card-fields input {
        font-size: 16px !important;
      }
      
      @supports (-webkit-touch-callout: none) {
        .form-group input,
        .form-group select,
        .form-group textarea,
        .card-fields input {
          font-size: 16px;
          line-height: 1.5;
          max-height: none;
        }
      }
      
      @media screen and (-webkit-min-device-pixel-ratio: 0) {
        .form-group input,
        .form-group select,
        .form-group textarea,
        .card-fields input {
          font-size: 16px;
          transform: scale(1);
          zoom: 1;
        }
      }
    }

    @media (max-width: 480px) {
      .checkout-full-title {
        font-size: 30px;
      }
      
      .step-title {
        font-size: 20px;
      }
      
      .progress-bar {
        margin: 15px auto 25px;
      }
      
      .step-circle {
        width: 25px;
        height: 25px;
        font-size: 14px;
      }
      
      .step-image {
        width: 180px;
        height: 130px;
      }
      
      .confirmation-title {
        font-size: 28px;
      }
      
      .confirmation-image-large {
        width: 200px;
        height: 150px;
      }
      
      .reenviar-correo-btn {
        padding: 10px 20px;
        min-width: 160px;
        font-size: 15px;
      }
      
      .form-group select,
      .form-group input,
      .form-group textarea {
        padding: 12px 15px;
        font-size: 15px;
      }
      
      .nav-btn {
        padding: 14px;
        font-size: 15px;
      }
      
      .transition-image {
        width: 180px;
        height: 180px;
      }
    }
  </style>
</head>
<body>
  <!-- Pantalla de transición simplificada -->
  <div class="transition-screen" id="transitionScreen">
    <img src="img/compra.png" alt="Redirigiendo" class="transition-image">
  </div>

  <!-- Notificaciones -->
  <div class="notification" id="notification">
    <div class="notification-content">
      <span class="notification-icon">✓</span>
      <span class="notification-text">El producto se agregó de manera exitosa</span>
    </div>
  </div>

  <div class="payment-error-notification" id="paymentErrorNotification">
    <i class="fas fa-exclamation-triangle"></i>
    <h3>Error al procesar el pago</h3>
    <p>Verifica el saldo o datos de tu tarjeta</p>
  </div>

  <div class="stock-notification" id="stockNotification">
    <i class="fas fa-exclamation-circle"></i>
    <h3>Stock insuficiente</h3>
    <p>No contamos con suficiente stock para esta cantidad</p>
  </div>

  <!-- Pantalla completa de checkout -->
  <div class="checkout-fullscreen" id="checkoutFullscreen">
    
    <div class="checkout-full-header">
      <h2 class="checkout-full-title">Nutricroc</h2>
    </div>
    
    <div class="checkout-full-content">
      <!-- Panel izquierdo: Resumen de compra (se oculta en móviles) -->
      <div class="checkout-left-panel">

  <!-- Título fijo -->
  <div class="checkout-summary-header">
    <h3 class="checkout-summary-title">Resumen de la compra</h3>

    <div class="checkout-summary-count">
      <span>Productos:</span>
      <span class="summary-total-value" id="checkoutProductCount">2</span>
    </div>
  </div>

  <!-- Lista de productos -->
  <div class="checkout-products-list" id="checkoutProductsList">
    <!-- Productos dinámicos -->
  </div>

  <!-- Totales fijos -->
  <div class="checkout-summary-footer">
    <div class="summary-total-row">
      <span class="summary-total-label">Subtotal:</span>
      <span class="summary-total-value" id="checkoutSubtotal">$85.00</span>
    </div>
    <div class="summary-total-row">
      <span class="summary-total-label">Envío:</span>
      <span class="summary-total-value" id="checkoutEnvio">Gratis</span>
    </div>
    <div class="summary-grand-total">
      <span class="summary-total-label">Total final:</span>
      <span class="summary-total-value" id="checkoutTotalAmount">$85.00</span>
    </div>
  </div>

</div>
      
      <!-- Panel derecho: Pasos del checkout (ocupa todo en móviles) -->
      <div class="checkout-right-panel">
        <!-- Spinner para cambio de paso -->
        <div class="step-spinner" id="stepSpinner">
          <div class="spinner"></div>
          <p class="step-spinner-text">Cargando...</p>
        </div>
        
        <!-- Barra de progreso -->
        <div class="progress-bar" id="progressBar">
          <div class="progress-step active" id="step1">
            <div class="step-circle">1</div>
            <div class="step-label">Entrega</div>
          </div>
          <div class="progress-step" id="step2">
            <div class="step-circle">2</div>
            <div class="step-label">Pago</div>
          </div>
          <div class="progress-step" id="step3">
            <div class="step-circle">3</div>
            <div class="step-label">Confirmación</div>
          </div>
        </div>
        
        <!-- Paso 1: Datos de entrega -->
        <div class="checkout-step active" id="stepContent1">
          <h2 class="step-title">Información de Entrega</h2>
          
          <div class="step-image-container">
            <img src="img/cocodriloenvio.png" alt="Entrega" class="step-image">
          </div>
          
          <form class="delivery-form" id="fullDeliveryForm">
            <div class="form-group">
              <label for="fullBuilding">Edificio de entrega</label>
              <select id="fullBuilding" name="fullBuilding" required>
                <option value="">Selecciona un edificio</option>
                <option value="A">Edificio A</option>
                <option value="B">Edificio B</option>
                <option value="C">Edificio C</option>
                <option value="D">Edificio D</option>
                <option value="X">Edificio X</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="fullClassroom">Salón de entrega</label>
              <select id="fullClassroom" name="fullClassroom" disabled required>
                <option value="">Selecciona un salón</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="fullRecipientName">Características de la persona que recibe</label>
              <input type="text" id="fullRecipientName" name="fullRecipientName" placeholder="Nombre completo del destinatario" required>
            </div>
            
            <div class="form-group">
              <label for="fullRecipientPhone">Teléfono del destinatario</label>
              <input type="tel" id="fullRecipientPhone" name="fullRecipientPhone" placeholder="Número de teléfono" required>
            </div>
            
            <div class="form-group">
              <label for="fullRecipientEmail">Correo electrónico</label>
              <input type="email" id="fullRecipientEmail" name="fullRecipientEmail" placeholder="correo@ejemplo.com" required>
            </div>
            
            <div class="form-group">
              <label for="fullSpecialInstructions">Instrucciones especiales (opcional)</label>
              <textarea id="fullSpecialInstructions" name="fullSpecialInstructions" rows="3" placeholder="Ej: Entregar en recepción, llamar antes de llegar, etc."></textarea>
            </div>
          </form>
          
          <div class="checkout-navigation">
            <button class="nav-btn nav-btn-secondary" id="backToCartBtnFull">Volver</button>
            <button class="nav-btn" id="continueToPaymentFullBtn">Continuar al pago</button>
          </div>
        </div>
        
        <!-- Paso 2: Método de pago -->
        <div class="checkout-step" id="stepContent2">
          <h2 class="step-title">Método de Pago</h2>
          
          <div class="step-image-container">
            <img src="img/procesodepago.png" alt="Pago" class="step-image">
          </div>
          
          <div class="payment-options">
            <div class="payment-option" data-method="paypal">
              <div class="payment-icon">
                <i class="fab fa-paypal"></i>
              </div>
              <div class="payment-label">PayPal</div>
              <div class="payment-radio">
                <input type="radio" name="fullPaymentMethod" value="paypal" id="fullPaypalRadio">
              </div>
            </div>
            
            <div class="payment-option" data-method="card">
              <div class="payment-icon">
                <i class="far fa-credit-card"></i>
              </div>
              <div class="payment-label">Tarjeta de Débito/Crédito</div>
              <div class="payment-radio">
                <input type="radio" name="fullPaymentMethod" value="card" id="fullCardRadio">
              </div>
            </div>
            
            <div class="payment-option" data-method="cash">
              <div class="payment-icon">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <div class="payment-label">Efectivo</div>
              <div class="payment-radio">
                <input type="radio" name="fullPaymentMethod" value="cash" id="fullCashRadio">
              </div>
            </div>
          </div>
          
          <!-- Campos de tarjeta -->
          <div class="card-fields" id="fullCardFields">
            <h3 class="step-title" style="font-size: 18px; margin-bottom: 20px;">Datos de la tarjeta</h3>
            
            <div class="form-group">
              <label for="fullCardNumber">Número de tarjeta</label>
              <input type="text" id="fullCardNumber" name="fullCardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
            </div>
            
            <div class="form-group">
              <label for="fullCardHolder">Nombre del titular</label>
              <input type="text" id="fullCardHolder" name="fullCardHolder" placeholder="Como aparece en la tarjeta">
            </div>
            
            <div class="expiry-cvv-container">
              <div class="form-group">
                <label for="fullExpiryDate">(MM/AA)</label>
                <input type="text" id="fullExpiryDate" name="fullExpiryDate" placeholder="MM/AA" maxlength="5">
              </div>
              
              <div class="form-group">
                <label for="fullCvv">CVV</label>
                <input type="text" id="fullCvv" name="fullCvv" placeholder="123" maxlength="4">
              </div>
            </div>
          </div>
          
          <div class="checkout-navigation">
            <button class="nav-btn nav-btn-secondary" id="backToDeliveryBtn">Volver a entrega</button>
            <button class="nav-btn" id="processPaymentBtn" disabled>Continuar con el pago</button>
          </div>
        </div>
        
        <!-- Paso 3: Confirmación -->
        <div class="checkout-step" id="stepContent3">
          <div class="confetti-success" id="confettiSuccess"></div>
          
          <div class="confirmation-content">
            <img src="img/compraexitosa.png" alt="Confirmación Nutricroc" class="confirmation-image-large">
            <h2 class="confirmation-title">¡Compra exitosa!</h2>
            <p class="confirmation-message">Tu compra se ha realizado con éxito. Revisa tu correo electrónico para la confirmación de tu compra. ¡Esperamos que disfrutes nuestros deliciosos postres!</p>
            
            <!-- Botón de reenviar correo -->
            <button class="reenviar-correo-btn" id="reenviarCorreoBtnFull">
              Reenviar correo
            </button>
            
            <div class="checkout-summary-total" style="margin-top: 30px; width: 100%; max-width: 500px; background: #f9f9f9; padding: 20px; border-radius: 10px;">
              <div class="summary-total-row">
                <span class="summary-total-label">Número de pedido:</span>
                <span class="summary-total-value" id="confirmationOrder">NUTR-2024-001234</span>
              </div>
              <div class="summary-total-row">
                <span class="summary-total-label">Fecha del pedido:</span>
                <span class="summary-total-value" id="confirmationDate">15 Dic 2024</span>
              </div>
              <div class="summary-total-row">
                <span class="summary-total-label">Método de pago:</span>
                <span class="summary-total-value" id="confirmationMethod">PayPal</span>
              </div>
              <div class="summary-total-row">
                <span class="summary-total-label">Subtotal:</span>
                <span class="summary-total-value" id="confirmationSubtotal">$85.00</span>
              </div>
              <div class="summary-total-row">
                <span class="summary-total-label">Envío:</span>
                <span class="summary-total-value" id="confirmationEnvio">Gratis</span>
              </div>
              <div class="summary-grand-total" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                <span class="summary-total-label">Total final:</span>
                <span class="summary-total-value" id="confirmationTotal">$85.00</span>
              </div>
            </div>
            
            <div class="checkout-navigation" style="margin-top: 40px;">
              <button class="nav-btn" id="finishCheckoutBtn">Seguir comprando</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let cartItems = [];
    let currentCheckoutFullStep = 1;
    let selectedPaymentMethod = null;
    let reenviarAttempts = 0;
    const MAX_REENVIAR_ATTEMPTS = 3;
    let reenviarBtnDisabled = false;
    let reenviarTimeout = null;
    
    // Variable para almacenar la página de origen
    let returnToPage = 'productos.html'; // Valor por defecto

    // Datos de los edificios y salones
    const buildingClassrooms = {
      'A': Array.from({length: 11}, (_, i) => `Salón ${i + 1}`),
      'B': Array.from({length: 11}, (_, i) => `Salón ${i + 1}`),
      'C': Array.from({length: 11}, (_, i) => `Salón ${i + 1}`),
      'D': Array.from({length: 7}, (_, i) => `Salón ${i + 1}`),
      'X': Array.from({length: 7}, (_, i) => `Salón ${i + 1}`)
    };

    // Elementos del DOM
    const checkoutFullscreen = document.getElementById('checkoutFullscreen');
    const checkoutProductsList = document.getElementById('checkoutProductsList');
    const checkoutProductCount = document.getElementById('checkoutProductCount');
    const checkoutSubtotal = document.getElementById('checkoutSubtotal');
    const checkoutTotalAmount = document.getElementById('checkoutTotalAmount');
    
    // Barra de progreso
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const stepContent1 = document.getElementById('stepContent1');
    const stepContent2 = document.getElementById('stepContent2');
    const stepContent3 = document.getElementById('stepContent3');
    const stepSpinner = document.getElementById('stepSpinner');
    
    // Paso de entrega
    const fullDeliveryForm = document.getElementById('fullDeliveryForm');
    const fullBuilding = document.getElementById('fullBuilding');
    const fullClassroom = document.getElementById('fullClassroom');
    const backToCartBtnFull = document.getElementById('backToCartBtnFull');
    const continueToPaymentFullBtn = document.getElementById('continueToPaymentFullBtn');
    
    // Paso de pago
    const fullPaymentOptions = document.querySelectorAll('.payment-option');
    const fullCardFields = document.getElementById('fullCardFields');
    const fullCardNumber = document.getElementById('fullCardNumber');
    const fullCardHolder = document.getElementById('fullCardHolder');
    const fullExpiryDate = document.getElementById('fullExpiryDate');
    const fullCvv = document.getElementById('fullCvv');
    const backToDeliveryBtn = document.getElementById('backToDeliveryBtn');
    const processPaymentBtn = document.getElementById('processPaymentBtn');
    
    // Paso de confirmación
    const confirmationDate = document.getElementById('confirmationDate');
    const confirmationMethod = document.getElementById('confirmationMethod');
    const confirmationOrder = document.getElementById('confirmationOrder');
    const confirmationSubtotal = document.getElementById('confirmationSubtotal');
    const confirmationEnvio = document.getElementById('confirmationEnvio');
    const confirmationTotal = document.getElementById('confirmationTotal');
    const finishCheckoutBtn = document.getElementById('finishCheckoutBtn');
    const confettiSuccess = document.getElementById('confettiSuccess');
    const reenviarCorreoBtnFull = document.getElementById('reenviarCorreoBtnFull');
    
    // Pantalla de transición
    const transitionScreen = document.getElementById('transitionScreen');
    
    // Notificaciones
    const paymentErrorNotification = document.getElementById('paymentErrorNotification');
    const stockNotification = document.getElementById('stockNotification');
    const notification = document.getElementById('notification');

    // ===== FUNCIONES DEL CARRITO =====
    
    function loadCartFromStorage() {
      const savedCart = localStorage.getItem('checkout_cart_items');
      if (savedCart) {
        try {
          cartItems = JSON.parse(savedCart);
        } catch (e) {
          console.error('Error al cargar el carrito:', e);
          cartItems = [];
        }
      }
    }
    
    function calculateCartTotals() {
      let subtotal = 0;
      let totalItems = 0;
      
      cartItems.forEach(item => {
        subtotal += parseFloat(item.price) * item.quantity;
        totalItems += item.quantity;
      });
      
      const envio = 0; // Envío gratis
      const total = subtotal + envio;
      
      return {
        subtotal: subtotal.toFixed(2),
        envio: envio.toFixed(2),
        total: total.toFixed(2),
        totalItems: totalItems
      };
    }
    
    function renderCheckoutProducts() {
      if (cartItems.length === 0) {
        checkoutProductsList.innerHTML = '<p class="cart-empty-text">No hay productos en el carrito</p>';
        return;
      }
      
      let itemsHTML = '';
      cartItems.forEach((item, index) => {
        const subtotal = (parseFloat(item.price) * item.quantity).toFixed(2);
        itemsHTML += `
          <div class="checkout-product-item">
            <div class="checkout-product-image">
              <img src="${item.image}" alt="${item.name}">
            </div>
            <div class="checkout-product-details">
              <div class="checkout-product-name">${item.name}</div>
              <div class="checkout-product-quantity">${item.quantity} × $${item.price}</div>
              <div class="checkout-product-price">$${subtotal}</div>
            </div>
          </div>
        `;
      });
      checkoutProductsList.innerHTML = itemsHTML;
    }
    
    function updateCartTotals() {
      const totals = calculateCartTotals();
      
      checkoutProductCount.textContent = totals.totalItems;
      checkoutSubtotal.textContent = `$${totals.subtotal}`;
      checkoutTotalAmount.textContent = `$${totals.total}`;
      
      confirmationSubtotal.textContent = `$${totals.subtotal}`;
      confirmationTotal.textContent = `$${totals.total}`;
    }

    // ===== FUNCIONES DEL CHECKOUT COMPLETO =====
    
    function showCheckoutFullscreen() {
      if (cartItems.length === 0) {
        // Redirigir a la página de origen o productos.html por defecto
        window.location.href = returnToPage;
        return;
      }
      
      checkoutFullscreen.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      showCheckoutFullStep(1);
      renderCheckoutProducts();
      updateCartTotals();
      resetReenviarBtn();
      
      // Deshabilitar el botón de pago inicialmente
      updatePaymentButtonState();
    }
    
    function closeCheckoutFullscreen() {
      if (currentCheckoutFullStep === 3) {
        // Si está en confirmación, limpiar carrito
        localStorage.removeItem('checkout_cart_items');
        cartItems = [];
      }
      
      checkoutFullscreen.classList.remove('active');
      document.body.style.overflow = 'auto';
      resetCheckoutFullForms();
    }
    
    function showTransitionScreenAndRedirect() {
      transitionScreen.classList.add('active');
      
      // Mostrar por 1.5 segundos y luego redirigir a la página de origen
      setTimeout(() => {
        window.location.href = returnToPage;
      }, 1500);
    }
    
    function showCheckoutFullStep(step) {
      currentCheckoutFullStep = step;
      
      // Ocultar todos los pasos
      stepContent1.classList.remove('active');
      stepContent2.classList.remove('active');
      stepContent3.classList.remove('active');
      
      // Remover clases activas de la barra de progreso
      step1.classList.remove('active', 'completed');
      step2.classList.remove('active', 'completed');
      step3.classList.remove('active', 'completed');
      
      // Mostrar spinner por 1.5 segundos
      stepSpinner.classList.add('active');
      
      setTimeout(() => {
        stepSpinner.classList.remove('active');
        
        // Mostrar el paso actual después del spinner
        if (step === 1) {
          stepContent1.classList.add('active');
          step1.classList.add('active');
        } else if (step === 2) {
          stepContent2.classList.add('active');
          step1.classList.add('completed');
          step2.classList.add('active');
          
          // Deshabilitar el botón de pago cuando se muestra el paso 2
          updatePaymentButtonState();
        } else if (step === 3) {
          stepContent3.classList.add('active');
          step1.classList.add('completed');
          step2.classList.add('completed');
          step3.classList.add('active');
          
          generateConfirmationInfo();
          createConfettiSuccess();
        }
      }, 1500);
    }
    
    function resetCheckoutFullForms() {
      fullDeliveryForm.reset();
      fullClassroom.disabled = true;
      fullClassroom.innerHTML = '<option value="">Selecciona un salón</option>';
      
      fullPaymentOptions.forEach(option => option.classList.remove('selected'));
      selectedPaymentMethod = null;
      fullCardFields.classList.remove('show');
      fullCardNumber.value = '';
      fullCardHolder.value = '';
      fullExpiryDate.value = '';
      fullCvv.value = '';
      
      currentCheckoutFullStep = 1;
      updatePaymentButtonState();
    }
    
    function updateFullClassroomOptions() {
      const building = fullBuilding.value;
      fullClassroom.innerHTML = '<option value="">Selecciona un salón</option>';
      
      if (building && buildingClassrooms[building]) {
        buildingClassrooms[building].forEach(classroom => {
          const option = document.createElement('option');
          option.value = classroom;
          option.textContent = classroom;
          fullClassroom.appendChild(option);
        });
        fullClassroom.disabled = false;
      } else {
        fullClassroom.disabled = true;
      }
    }
    
    function validateFullDeliveryForm() {
      const building = fullBuilding.value;
      const classroom = fullClassroom.value;
      const recipientName = document.getElementById('fullRecipientName').value;
      const recipientPhone = document.getElementById('fullRecipientPhone').value;
      const recipientEmail = document.getElementById('fullRecipientEmail').value;
      
      if (!building) {
        alert('Por favor selecciona un edificio.');
        return false;
      }
      
      if (!classroom) {
        alert('Por favor selecciona un salón.');
        return false;
      }
      
      if (!recipientName.trim()) {
        alert('Por favor ingresa el nombre del destinatario.');
        return false;
      }
      
      if (!recipientPhone.trim()) {
        alert('Por favor ingresa el teléfono del destinatario.');
        return false;
      }
      
      if (!recipientEmail.trim()) {
        alert('Por favor ingresa el correo electrónico.');
        return false;
      }
      
      // Validación básica de email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(recipientEmail)) {
        alert('Por favor ingresa un correo electrónico válido.');
        return false;
      }
      
      return true;
    }
    
    function validateFullPaymentForm() {
      if (!selectedPaymentMethod) {
        alert('Por favor selecciona un método de pago.');
        return false;
      }
      
      if (selectedPaymentMethod === 'card') {
        const cardNumber = fullCardNumber.value.replace(/\s/g, '');
        const cardHolder = fullCardHolder.value.trim();
        const expiryDate = fullExpiryDate.value;
        const cvv = fullCvv.value;
        
        const cardNumberValid = /^\d{16}$/.test(cardNumber);
        if (!cardNumberValid) {
          alert('El número de tarjeta debe tener 16 dígitos.');
          return false;
        }
        
        const cardHolderValid = cardHolder.length >= 3;
        if (!cardHolderValid) {
          alert('El nombre del titular debe tener al menos 3 caracteres.');
          return false;
        }
        
        const expiryDateValid = /^\d{2}\/\d{2}$/.test(expiryDate);
        if (!expiryDateValid) {
          alert('La fecha de expiración debe tener el formato MM/AA.');
          return false;
        }
        
        const cvvValid = /^\d{3,4}$/.test(cvv);
        if (!cvvValid) {
          alert('El CVV debe tener 3 o 4 dígitos.');
          return false;
        }
        
        return true;
      }
      
      return true;
    }
    
    // Función para actualizar el estado del botón de pago
    function updatePaymentButtonState() {
      if (currentCheckoutFullStep === 2) {
        // Habilitar el botón solo si hay un método de pago seleccionado
        processPaymentBtn.disabled = !selectedPaymentMethod;
      }
    }
    
    function generateConfirmationInfo() {
      const now = new Date();
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      confirmationDate.textContent = now.toLocaleDateString('es-ES', options);
      
      confirmationMethod.textContent = getPaymentMethodName(selectedPaymentMethod);
      
      const orderNumber = 'NUTR-' + now.getFullYear() + '-' + Math.floor(100000 + Math.random() * 900000);
      confirmationOrder.textContent = orderNumber;
      
      const totals = calculateCartTotals();
      confirmationSubtotal.textContent = `$${totals.subtotal}`;
      confirmationTotal.textContent = `$${totals.total}`;
    }
    
    function getPaymentMethodName(method) {
      switch(method) {
        case 'paypal': return 'PayPal';
        case 'card': return 'Tarjeta de crédito/débito';
        case 'cash': return 'Efectivo';
        default: return 'No seleccionado';
      }
    }
    
    function createConfettiSuccess() {
      confettiSuccess.innerHTML = '';
      for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        confetti.style.backgroundColor = i % 4 === 0 ? '#295732' : 
                                        i % 4 === 1 ? '#1e3d24' : 
                                        i % 4 === 2 ? '#704214' : '#76DCD8';
        confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
        confetti.style.animationDelay = Math.random() * 5 + 's';
        confettiSuccess.appendChild(confetti);
      }
    }

    // ===== FUNCIONES DE NOTIFICACIONES =====
    
    function showNotification(message = 'El producto se agregó de manera exitosa') {
      notification.querySelector('.notification-text').textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    function showPaymentErrorNotification() {
      paymentErrorNotification.classList.add('show');
      setTimeout(() => {
        paymentErrorNotification.classList.remove('show');
      }, 5000);
    }
    
    function showStockNotification() {
      stockNotification.classList.add('show');
      setTimeout(() => {
        stockNotification.classList.remove('show');
      }, 3000);
    }

    // ===== FUNCIONES PARA REENVIAR CORREO =====
    
    function resetReenviarBtn() {
      reenviarAttempts = 0;
      reenviarBtnDisabled = false;
      if (reenviarTimeout) {
        clearTimeout(reenviarTimeout);
        reenviarTimeout = null;
      }
      
      const btn = document.getElementById('reenviarCorreoBtnFull');
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Reenviar correo';
      }
    }
    
    function disableReenviarBtnTemporalmente() {
      const btn = document.getElementById('reenviarCorreoBtnFull');
      if (!btn) return;
      
      btn.disabled = true;
      btn.textContent = 'Espere 60 segundos';
      
      reenviarTimeout = setTimeout(() => {
        if (reenviarAttempts < MAX_REENVIAR_ATTEMPTS) {
          btn.disabled = false;
          btn.textContent = 'Reenviar correo';
          reenviarBtnDisabled = false;
        }
      }, 60000);
    }
    
    function handleReenviarCorreo() {
      if (reenviarBtnDisabled || reenviarAttempts >= MAX_REENVIAR_ATTEMPTS) {
        return;
      }
      
      reenviarAttempts++;
      reenviarBtnDisabled = true;
      
      // Simular envío de correo
      showNotification('Correo reenviado con éxito');
      
      if (reenviarAttempts >= MAX_REENVIAR_ATTEMPTS) {
        const btn = document.getElementById('reenviarCorreoBtnFull');
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Límite alcanzado';
        }
      } else {
        disableReenviarBtnTemporalmente();
      }
    }

    // ===== FUNCIÓN PARA OBTENER LA PÁGINA DE ORIGEN =====
    function getReturnPageFromURL() {
      // Obtener la URL de referencia desde localStorage o parámetro URL
      const urlParams = new URLSearchParams(window.location.search);
      const referrer = urlParams.get('from');
      
      // Posibles páginas válidas
      const validPages = ['index.html', 'productos.html', 'contacto.html', 'nosotros.html','producto.html','sobrenosotros.html'];
      
      if (referrer && validPages.includes(referrer)) {
        return referrer;
      }
      
      // Si no hay parámetro, intentar obtener de localStorage
      const storedReferrer = localStorage.getItem('checkout_referrer');
      if (storedReferrer && validPages.includes(storedReferrer)) {
        return storedReferrer;
      }
      
      // Valor por defecto
      return 'productos.html';
    }

    // ===== EVENT LISTENERS =====
    
    // Volver al carrito - ahora muestra transición y redirige a la página de origen
    backToCartBtnFull.addEventListener('click', () => {
      closeCheckoutFullscreen();
      showTransitionScreenAndRedirect();
    });
    
    // Actualizar salones cuando se selecciona un edificio
    fullBuilding.addEventListener('change', updateFullClassroomOptions);
    
    // Continuar al pago
    continueToPaymentFullBtn.addEventListener('click', () => {
      if (validateFullDeliveryForm()) {
        showCheckoutFullStep(2);
      }
    });
    
    // Selección de método de pago
    fullPaymentOptions.forEach(option => {
      option.addEventListener('click', () => {
        fullPaymentOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        
        const radio = option.querySelector('input[type="radio"]');
        if (radio) {
          radio.checked = true;
        }
        
        selectedPaymentMethod = option.dataset.method;
        
        // Habilitar/deshabilitar botón de pago según selección
        updatePaymentButtonState();
        
        if (selectedPaymentMethod === 'card') {
          fullCardFields.classList.add('show');
          setTimeout(() => {
            fullCardFields.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 300);
        } else {
          fullCardFields.classList.remove('show');
        }
      });
    });
    
    // Formatear número de tarjeta
    fullCardNumber.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
      e.target.value = value.substring(0, 19);
    });
    
    // Formatear fecha de expiración
    fullExpiryDate.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
      }
      e.target.value = value.substring(0, 5);
    });
    
    // Solo números para CVV
    fullCvv.addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
    });
    
    // Volver al envío
    backToDeliveryBtn.addEventListener('click', () => {
      showCheckoutFullStep(1);
    });
    
    // Procesar pago
    processPaymentBtn.addEventListener('click', () => {
      if (!selectedPaymentMethod) {
        alert('Por favor selecciona un método de pago.');
        return;
      }
      
      if (selectedPaymentMethod === 'card' && !validateFullPaymentForm()) {
        return;
      }
      
      if (selectedPaymentMethod === 'card') {
        const cardNumber = fullCardNumber.value.replace(/\s/g, '');
        
        // Tarjeta específica que genera error (para demo)
        if (cardNumber === '4242424242424242') {
          showPaymentErrorNotification();
          return;
        }
      }
      
      if (selectedPaymentMethod === 'paypal') {
        window.open('https://www.paypal.com', '_blank');
      }
      
      // Simular procesamiento exitoso
      showCheckoutFullStep(3);
    });
    
    // Finalizar checkout - muestra transición y redirige a la página de origen
    finishCheckoutBtn.addEventListener('click', () => {
      closeCheckoutFullscreen();
      showTransitionScreenAndRedirect();
    });
    
    // Reenviar correo
    if (reenviarCorreoBtnFull) {
      reenviarCorreoBtnFull.addEventListener('click', handleReenviarCorreo);
    }

    // ===== INICIALIZACIÓN =====
    
    function init() {
      // Obtener la página de origen desde la URL o localStorage
      returnToPage = getReturnPageFromURL();
      
      // Cargar carrito desde localStorage
      loadCartFromStorage();
      
      // Mostrar el checkout automáticamente
      showCheckoutFullscreen();
      
      // Si no hay productos, redirigir a la página de origen
      if (cartItems.length === 0) {
        window.location.href = returnToPage;
        return;
      }
      
      renderCheckoutProducts();
      updateCartTotals();
      
      // Establecer fecha actual en confirmación
      const now = new Date();
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      confirmationDate.textContent = now.toLocaleDateString('es-ES', options);
      
      // Forzar color negro en los selects después de cargar
      setTimeout(() => {
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
          select.style.color = '#000';
        });
      }, 100);
    }
    
    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>